@using BWAPI.NET
@using MyBotWeb.Services
@inject BotService BotService
@implements IDisposable
<div class="bg-gray-800 rounded-lg flex flex-row gap-4 p-3 mb-3">
    <div class="flex-1 bg-gray-700 rounded-lg p-1 flex flex-row justify-center">
        <span class="text-white">@GetMinerals()</span>
        <span class="text-gray-300 ps-2">minerals</span>
    </div>
    <div class="flex-1 bg-gray-700 rounded-lg p-1 flex flex-row justify-center">
        <span class="text-white">@GetGas()</span>
        <span class="text-gray-300 ps-2">gas</span>
    </div>
    <div class="flex-1 bg-gray-700 rounded-lg p-1 flex flex-row justify-center">
        <span class="text-white">@GetSupplyUsed() / @GetSupplyTotal()</span>
        <span class="text-gray-300 ps-2">supply</span>
    </div>
</div>

<div class=" mb-4">
    <h2 class="">Units</h2>
    @foreach (var unitGroup in GetUnitsByType())
    {
        <div class="mt-2 p-2 bg-gray-800 rounded-lg">
            <div class="text-gray-300">@unitGroup.Key.ToString()s</div>
            <div class="flex flex-col ps-3">
                @foreach (var unit in unitGroup.Value)
                {
                    <div>@unit.GetHitPoints()</div>
                    <div class="text-gray-400 ps-3 text-sm">
                        <div>
                            @unit.GetOrder().ToString()
                        </div>
                        <div>
                            @if (unit.GetTarget() != null)
                            {
                                @unit.GetTarget().GetUnitType().ToString()
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<div class="">
    <h2 class="">Buildings</h2>
        <div class="mt-2 p-2 bg-gray-800 rounded-lg">
        @foreach (var buildingGroup in GetBuildingsByType())
        {
            <div class="text-gray-300">@buildingGroup.Key.ToString()s</div>
            <div class="flex flex-col ps-3">
                @foreach (var building in buildingGroup.Value)
                {
                    <div class="text-gray-400 ps-3 text-sm">
                        @if (building.IsTraining())
                        {
                            <div class="flex flex-row gap-2">
                                <div>
                                    Training: 
                                </div>
                                @foreach (var queued in building.GetTrainingQueue())
                                {
                                    <div>
                                        @queued 
                                    </div>
                                }
                            </div>
                        }
                        @if (building.IsResearching())
                        {
                            <div>
                                Researching: @building.GetTech()
                            </div>
                        }
                        @if (building.IsUpgrading())
                        {
                            <div>
                                Upgrading: @building.GetUpgrade()
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private System.Threading.Timer? timer;

    protected override void OnInitialized()
    {
        // Refresh the UI every 500ms
        timer = new(_ =>
        {
            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromMilliseconds(500));
    }

    public void Dispose()
    {
        timer?.Dispose();
    }

    private int GetFrameCount() => BotService.Game?.GetFrameCount() ?? 0;
    private int GetMinerals() => BotService.Game?.Self()?.Minerals() ?? 0;
    private int GetGas() => BotService.Game?.Self()?.Gas() ?? 0;
    private int GetSupplyUsed() => BotService.Game?.Self()?.SupplyUsed() ?? 0;
    private int GetSupplyTotal() => BotService.Game?.Self()?.SupplyTotal() ?? 0;

    private IEnumerable<BWAPI.NET.Unit> GetUnits()
    {
        if (BotService.Game == null) return Enumerable.Empty<BWAPI.NET.Unit>();

        var allUnits = BotService.Game.Self()?.GetUnits() ?? Enumerable.Empty<BWAPI.NET.Unit>();
        return allUnits.Where(u => u.Exists() && !u.GetUnitType().IsBuilding());
    }

    private Dictionary<UnitType, Unit[]> GetUnitsByType()
    {
        var units = GetUnits();
        return units.GroupBy(u => u.GetUnitType())
        .ToDictionary(g => g.Key, g => g.ToArray());
    }

    private Dictionary<UnitType, Unit[]> GetBuildingsByType()
    {
        var buildings = GetBuildings();
        return buildings.GroupBy(u => u.GetUnitType())
        .ToDictionary(g => g.Key, g => g.ToArray());
    }

    private IEnumerable<BWAPI.NET.Unit> GetBuildings()
    {
        if (BotService.Game == null) return Enumerable.Empty<BWAPI.NET.Unit>();

        var allUnits = BotService.Game.Self()?.GetUnits() ?? Enumerable.Empty<BWAPI.NET.Unit>();
        return allUnits.Where(u => u.Exists() && u.GetUnitType().IsBuilding());
    }
}